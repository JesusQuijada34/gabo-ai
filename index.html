<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Influent Gabo AI Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --color-bubble: linear-gradient(145deg, #005eff, #00ffff);
      --input-bg: #111;
      --input-border: #00ffff;
      --bubble-radius: 18px;
      --settings-bg: linear-gradient(140deg, #0036a2 40%, #00c6fb 100%);
      --settings-shadow: 0 8px 32px 0 rgba(0, 54, 162, 0.37);
      --sidebar-bg: #021f3a;
      --sidebar-active: #00c6fb44;
      --sidebar-width: 180px;
    }
    body {
      margin: 0;
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
      background: linear-gradient(135deg, #001b3a 0%, #2473c8 50%, #00c6fb 100%);
      color: #fff;
      display: flex;
      flex-direction: row;
      transition: background 1s;
      animation: gradientMove 20s ease infinite;
      overflow: hidden;
      height: 100vh;
    }
    @keyframes gradientMove {
      0% {background-position: 0% 50%;}
      50% {background-position: 100% 50%;}
      100% {background-position: 0% 50%;}
    }
    /* Sidebar temas */
    #sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 0.7rem 0.5rem;
      box-shadow: 2px 0 8px 0 rgba(0, 54, 162, 0.09);
      z-index: 5;
      min-width: 120px;
      gap: 0.7rem;
    }
    #sidebar h2 {
      font-size: 1rem;
      font-weight: 500;
      letter-spacing: 0.02em;
      margin: 0 0 0.7rem 0.2rem;
      color: #00c6fb;
    }
    .tema-list {
      flex: 1;
      overflow-y: auto;
    }
    .tema {
      cursor: pointer;
      padding: 0.45rem 0.8rem;
      border-radius: 8px;
      margin-bottom: 0.15rem;
      background: none;
      border: none;
      color: inherit;
      text-align: left;
      font-size: 0.98rem;
      transition: background 0.2s;
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .tema.active {
      background: var(--sidebar-active);
      font-weight: 500;
      color: #fff;
    }
    .tema .close {
      margin-left: auto;
      font-size: 0.9em;
      color: #ccc;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0 0.2em;
      border-radius: 3px;
      transition: color 0.2s;
    }
    .tema .close:hover { color: #ff4444; }
    #add-tema {
      margin: 0.6rem 0 0.2rem 0.2rem;
      background: #00c6fb;
      color: #031d3d;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      padding: 0.5rem 0.9rem;
      transition: background 0.2s;
    }
    #add-tema:hover { background: #005eff; color: #fff; }

    /* Main area */
    #main {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      position: relative;
      height: 100vh;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 2rem 1rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-height: 0;
      transition: background 0.5s;
      z-index: 1;
    }
    .bubble {
      max-width: 70%;
      margin: 0.5rem;
      padding: 1rem 1.3rem;
      border-radius: var(--bubble-radius);
      background: var(--color-bubble);
      color: #222;
      position: relative;
      animation: fadeIn 0.5s;
      white-space: pre-wrap;
      box-shadow: 0 4px 18px 0 rgba(0, 54, 162, 0.25);
      font-size: 0.95rem;
      word-break: break-word;
      overflow-wrap: anywhere;
      transition: transform 0.15s;
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      line-height: 1.55;
    }
    .bubble code {
      font-family: 'Roboto Mono', 'Menlo', 'Monaco', monospace;
      font-size: 0.88rem;
      background: #222;
      color: #00c6fb;
      border-radius: 5px;
      padding: 0.14em 0.32em;
      box-shadow: 0 1px 4px #0036a277;
    }
    .bubble pre {
      background: #181818;
      color: #00eaff;
      font-family: 'Roboto Mono', 'Menlo', 'Monaco', monospace;
      font-size: 0.93rem;
      border-radius: 7px;
      padding: 1em 1.3em 1.3em 1em;
      margin: 0.5em 0 0.2em 0;
      overflow-x: auto;
      position: relative;
      box-shadow: 0 2px 12px #0036a244;
      white-space: pre;
      word-break: break-all;
      max-width: 100%;
    }
    .copy-btn {
      position: absolute;
      top: 9px;
      right: 16px;
      background: #005eff;
      color: #fff;
      border: none;
      font-size: 0.97rem;
      border-radius: 7px;
      cursor: pointer;
      padding: 0.22em 0.8em;
      z-index: 2;
      transition: background 0.2s;
    }
    .copy-btn:hover { background: #00c6fb; color: #005eff; }
    .user {
      align-self: flex-end;
      border-top-right-radius: 0;
      background: linear-gradient(145deg, #00c6fb, #005eff);
      color: #1d1d3d;
      font-weight: 500;
      box-shadow: 0 2px 14px 0 rgba(0, 198, 251, 0.13);
    }
    .gabo {
      align-self: flex-start;
      border-top-left-radius: 0;
    }
    .footer {
      font-size: 0.72rem;
      opacity: 0.7;
      margin-top: 5px;
      display: flex;
      justify-content: space-between;
      font-family: inherit;
      color: #555;
    }
    #controls {
      display: flex;
      padding: 1.2rem;
      background: rgba(0,0,0,0.42);
      backdrop-filter: blur(12px);
      gap: 0.7rem;
      z-index: 2;
      box-shadow: 0 -4px 18px 0 rgba(0, 54, 162, 0.12);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      margin-top: auto;
    }
    #input {
      flex: 1;
      padding: 0.9rem;
      font-size: 1.03rem;
      border-radius: 10px;
      background: var(--input-bg);
      color: white;
      border: 2px solid var(--input-border);
      outline: none;
      transition: background 0.4s, color 0.4s, border 0.4s;
      box-shadow: 0 2px 8px 0 rgba(0, 54, 162, 0.12);
      font-family: inherit;
    }
    #input:focus {
      border-color: #00c6fb;
      background: #222;
      color: #00c6fb;
    }
    #send {
      padding: 0.9rem 1.3rem;
      font-weight: bold;
      background: linear-gradient(45deg, #00ffff, #0055ff);
      color: black;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.08rem;
      transition: background 0.3s, color 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 8px 0 rgba(0, 54, 162, 0.1);
      font-family: inherit;
    }
    #send:active {
      background: linear-gradient(45deg, #0055ff, #00ffff);
      color: #222;
      box-shadow: 0 4px 18px 0 rgba(0, 54, 162, 0.18);
    }
    /* Mini window for settings */
    #settings-btn {
      position: absolute;
      top: 18px;
      right: 24px;
      background: linear-gradient(45deg, #00c6fb, #005eff);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.6rem;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 4px 18px 0 rgba(0, 54, 162, 0.19);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    #settings-btn:hover {
      background: linear-gradient(45deg, #005eff, #00c6fb);
    }
    #settings-modal {
      position: fixed;
      top: 60px;
      right: 34px;
      width: 265px;
      background: var(--settings-bg);
      color: white;
      border-radius: 16px;
      box-shadow: var(--settings-shadow);
      padding: 1.2rem 1rem 1rem 1rem;
      z-index: 100;
      display: none;
      animation: popupAnim 0.4s;
    }
    @keyframes popupAnim {
      from {opacity: 0; transform: translateY(-30px);}
      to {opacity: 1; transform: translateY(0);}
    }
    #settings-modal h3 {
      margin-top: 0;
      font-size: 1.08rem;
      text-align: center;
      letter-spacing: 0.04em;
      margin-bottom: 0.6em;
      font-weight: 500;
      color: #fff;
      text-shadow: 0 2px 8px #005eff44;
    }
    #settings-modal label {
      margin: 9px 0 3px 0;
      display: block;
      font-size: 0.99em;
      font-weight: 500;
      color: #e4f3ff;
    }
    #settings-modal select {
      background: #222;
      color: white;
      border: 1px solid #00ffff;
      margin: 4px 0 12px 0;
      border-radius: 6px;
      width: 100%;
      padding: 5px 4px;
      font-size: 1em;
      font-family: inherit;
      transition: border 0.3s;
    }
    #settings-close {
      position: absolute;
      top: 9px;
      right: 12px;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.25rem;
      cursor: pointer;
      font-weight: bold;
      padding: 0;
      z-index: 110;
      transition: color 0.2s;
    }
    #settings-close:hover {
      color: #00ffff;
    }
    #delete-history-btn {
      margin-top: 9px;
      background: #ff4444;
      color: #fff;
      border: none;
      border-radius: 7px;
      font-size: 0.95em;
      padding: 0.5em 1em;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      box-shadow: 0 2px 8px #0036a244;
      transition: background 0.2s;
    }
    #delete-history-btn:hover { background: #e20000; }
    /* Animaci√≥n de entrada a las burbujas */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(18px);}
      to { opacity: 1; transform: translateY(0);}
    }
    /* Responsive */
    @media (max-width: 700px) {
      #sidebar { width: 65px; min-width: 0; padding: 0.3rem 0.2rem; }
      #sidebar h2 { font-size: 0.91rem; }
      #sidebar .tema { font-size: 0.9rem; padding: 0.3rem 0.2rem; }
      #main { padding-left: 0 !important; }
    }
    @media (max-width: 600px) {
      #settings-modal {
        right: 10px;
        width: 95vw;
        min-width: 0;
        max-width: 400px;
        top: 56px;
      }
      #settings-btn {
        right: 10px;
        top: 8px;
      }
      #controls {
        padding: 0.7rem;
      }
      #chat {
        padding: 1rem 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Temas</h2>
    <div class="tema-list" id="tema-list"></div>
    <button id="add-tema">+ Nuevo tema</button>
  </div>
  <div id="main">
    <div id="popup"></div>
    <button id="settings-btn" title="Configuraci√≥n">‚öôÔ∏è</button>
    <div id="settings-modal">
      <button id="settings-close" title="Cerrar">&times;</button>
      <h3>Configuraci√≥n de Chat</h3>
      <label for="color">Color burbuja:</label>
      <select id="color">
        <option value="linear-gradient(145deg, #005eff, #00ffff)">Azul Ne√≥n</option>
        <option value="linear-gradient(145deg, #00ff88, #00ffc9)">Verde Menta</option>
        <option value="linear-gradient(145deg, #ff00cc, #9900ff)">Rosado Violeta</option>
        <option value="linear-gradient(145deg, #f5bb00, #00c6fb)">Amarillo Cielo</option>
        <option value="linear-gradient(145deg, #ff7b00, #ffef00)">Naranja Sol</option>
        <option value="linear-gradient(145deg, #222, #444)">Gris Oscuro</option>
        <option value="linear-gradient(145deg, #c2e7ff, #a8f0e6)">Aqua Pastel</option>
        <option value="linear-gradient(145deg, #c800ff, #ff0080)">Morado Intenso</option>
        <option value="linear-gradient(145deg, #ffe0e0, #fff200)">Rosado Amarillo</option>
      </select>
      <label for="inputstyle">Estilo input:</label>
      <select id="inputstyle">
        <option value="#111|#00ffff">Oscuro Ne√≥n</option>
        <option value="#fff|#0077cc">Claro Azul</option>
        <option value="#002040|#00c6fb">Azul Oscuro</option>
        <option value="#d2f3ff|#005eff">Celeste</option>
        <option value="#ffe0e0|#ff0080">Rosado Pastel</option>
        <option value="#222|#444">Gris Oscuro</option>
        <option value="#ffffe0|#ffd700">Amarillo Claro</option>
        <option value="#c2e7ff|#a8f0e6">Aqua Pastel</option>
      </select>
      <button id="delete-history-btn">üóëÔ∏è Eliminar historial</button>
    </div>
    <div id="chat"></div>
    <div id="controls">
      <input type="text" id="input" placeholder="Escribe tu mensaje..." autocomplete="off" />
      <button id="send">Enviar</button>
    </div>
    <audio id="blup" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>
  </div>
  <script>
    document.body.style.backgroundSize = "200% 200%";

    // Temas en localStorage
    const TEMAS_KEY = "gabo_temas";
    function loadTemas() {
      try { return JSON.parse(localStorage.getItem(TEMAS_KEY)) || []; }
      catch { return []; }
    }
    function saveTemas(temas) {
      localStorage.setItem(TEMAS_KEY, JSON.stringify(temas));
    }

    // Dispositivo
    function getDeviceName() {
      let name = localStorage.getItem("gabo_device_name");
      if (!name) {
        name = navigator.userAgent.replace(/\W+/g, "_") + "_" + screen.width + "x" + screen.height;
        localStorage.setItem("gabo_device_name", name);
      }
      return name;
    }
    const deviceName = getDeviceName();

    // Historial por tema y dispositivo
    function historyKeyForTema(temaId) {
      return "gabo_historial_" + deviceName + "_" + temaId;
    }
    function saveHistory(temaId, history) {
      localStorage.setItem(historyKeyForTema(temaId), JSON.stringify(history));
    }
    function loadHistory(temaId) {
      try { return JSON.parse(localStorage.getItem(historyKeyForTema(temaId))) || []; }
      catch { return []; }
    }
    function deleteHistory(temaId) {
      localStorage.removeItem(historyKeyForTema(temaId));
    }

    // UI vars
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const send = document.getElementById("send");
    const popup = document.getElementById("popup");
    const blup = document.getElementById("blup");
    const temaListDiv = document.getElementById("tema-list");
    const addTemaBtn = document.getElementById("add-tema");

    // Configuraci√≥n
    const settingsBtn = document.getElementById("settings-btn");
    const settingsModal = document.getElementById("settings-modal");
    const settingsClose = document.getElementById("settings-close");
    const deleteHistoryBtn = document.getElementById("delete-history-btn");

    settingsBtn.onclick = () => {
      settingsModal.style.display = "block";
      settingsBtn.style.display = "none";
    };
    settingsClose.onclick = () => {
      settingsModal.style.display = "none";
      settingsBtn.style.display = "flex";
    };
    window.addEventListener("mousedown", e => {
      if (settingsModal.style.display === "block" && !settingsModal.contains(e.target) && e.target !== settingsBtn) {
        settingsModal.style.display = "none";
        settingsBtn.style.display = "flex";
      }
    });

    document.getElementById("color").onchange = (e) =>
      document.documentElement.style.setProperty("--color-bubble", e.target.value);

    document.getElementById("inputstyle").onchange = (e) => {
      const [bg, border] = e.target.value.split("|");
      document.documentElement.style.setProperty("--input-bg", bg);
      document.documentElement.style.setProperty("--input-border", border);
      const textColor = bg === "#fff" || bg === "#d2f3ff" || bg === "#ffe0e0" || bg === "#ffffe0" ? "#222" : "white";
      input.style.color = textColor;
      input.style.background = bg;
      input.style.borderColor = border;
    };

    // Temas barra lateral
    let temas = loadTemas();
    let activeTemaId = temas.length ? temas[0].id : null;
    function renderTemas() {
      temaListDiv.innerHTML = "";
      temas.forEach((t, idx) => {
        const div = document.createElement("button");
        div.className = "tema" + (t.id === activeTemaId ? " active" : "");
        div.textContent = t.nombre;
        div.onclick = () => { selectTema(t.id); };
        // Eliminar tema
        const closeBtn = document.createElement("button");
        closeBtn.className = "close";
        closeBtn.innerHTML = "‚úñ";
        closeBtn.title = "Eliminar tema";
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm("¬øEliminar este tema y su historial?")) {
            if (t.id === activeTemaId && temas.length > 1) {
              let nextTema = temas.find(tm => tm.id !== t.id);
              selectTema(nextTema.id);
            }
            deleteHistory(t.id);
            temas = temas.filter(tm => tm.id !== t.id);
            saveTemas(temas);
            renderTemas();
            if (!temas.length) {
              activeTemaId = null;
              chat.innerHTML = "";
            }
          }
        };
        div.appendChild(closeBtn);
        temaListDiv.appendChild(div);
      });
    }
    function selectTema(id) {
      if (activeTemaId === id) return;
      activeTemaId = id;
      renderTemas();
      loadAndRenderHistory();
    }
    function addTema() {
      let nombre = prompt("Nombre del nuevo tema:");
      if (!nombre) return;
      let newTema = { id: "tema_" + Date.now(), nombre };
      temas.push(newTema);
      saveTemas(temas);
      selectTema(newTema.id);
    }
    addTemaBtn.onclick = addTema;

    // Renderiza historial por tema
    let history = [];
    function loadAndRenderHistory() {
      chat.innerHTML = "";
      history = activeTemaId ? loadHistory(activeTemaId) : [];
      if (!history.length && activeTemaId) {
        setTimeout(() => {
          addBubble("üëã ¬°Hola! Soy <b>Gabo</b>, tu asistente AI.<br>¬øEn qu√© puedo ayudarte hoy?", "gabo", true, true, false, true);
        }, 400);
      } else {
        history.forEach(msg => {
          addBubble(msg.text, msg.role, msg.sent, msg.received, msg.read, true);
        });
      }
    }

    // Eliminar historial del tema actual
    deleteHistoryBtn.onclick = () => {
      if (activeTemaId && confirm("¬øEliminar historial de este tema?")) {
        deleteHistory(activeTemaId);
        loadAndRenderHistory();
      }
    };

    // Utilidades burbuja/chat
    function getTime() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }
    function verifyState(sent, received, read) {
      if (!received) return "‚úì";
      if (read) return "<span style='color:#00ffff'>‚úì‚úì</span>";
      return "‚úì‚úì";
    }
    function addBubble(text, role = "gabo", sent = true, received = true, read = false, noSave) {
      const bubble = document.createElement("div");
      bubble.className = `bubble ${role}`;

      // Procesar markdown y bloques de c√≥digo para copiar
      let html = marked.parse(text.replace(/DeepSeek/gi, "Gabo"));
      bubble.innerHTML = html;

      // Buscar bloques de c√≥digo y agregar bot√≥n copiar
      bubble.querySelectorAll("pre > code").forEach(codeBlock => {
        const pre = codeBlock.parentNode;
        pre.style.position = "relative";
        const btn = document.createElement("button");
        btn.className = "copy-btn";
        btn.textContent = "Copiar";
        btn.onclick = () => {
          navigator.clipboard.writeText(codeBlock.textContent);
          btn.textContent = "Copiado!";
          setTimeout(() => btn.textContent = "Copiar", 1200);
        };
        pre.appendChild(btn);
      });

      const footer = document.createElement("div");
      footer.className = "footer";
      if (role === "user") {
        footer.innerHTML = `<span>${getTime()}</span><span>${verifyState(sent, received, read)}</span>`;
      } else {
        footer.innerHTML = `<span>${getTime()}</span>`;
      }

      bubble.appendChild(footer);
      chat.appendChild(bubble);
      chat.scrollTop = chat.scrollHeight;

      // Animar burbuja al entrar
      bubble.animate([
        { opacity: 0, transform: "translateY(18px)" },
        { opacity: 1, transform: "translateY(0)" }
      ], {
        duration: 420,
        easing: "ease"
      });

      // Guardar en historial si no es carga inicial
      if (!noSave && activeTemaId) {
        history.push({ text, role, time: Date.now(), sent, received, read });
        saveHistory(activeTemaId, history);
      }
    }

    function sendMessage() {
      if (!activeTemaId) {
        alert("Primero crea o selecciona un tema.");
        return;
      }
      const msg = input.value.trim();
      if (!msg) return;
      input.value = "";
      send.disabled = true;
      send.textContent = "Pensando...";

      addBubble(msg, "user", true, false, false);

      fetch("https://api.together.xyz/v1/chat/completions", {
        method: "POST",
        headers: {
          Authorization: "Bearer 97301d064786753021066a79298e18af22d5d545140f99994373bf3ac82c1210",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "deepseek-ai/DeepSeek-V3",
          messages: [{ role: "user", content: msg }],
        }),
      })
      .then(res => {
        if (!res.ok) throw new Error("Sin conexi√≥n");
        return res.json();
      })
      .then(data => {
        let texto = data.choices[0].message.content || "";
        blup.play();
        addBubble(texto, "gabo");
      })
      .catch(() => {
        popup.style.display = "block";
        setTimeout(() => (popup.style.display = "none"), 4000);
        addBubble("No se pudo entregar el mensaje", "user", true, false, false);
      })
      .finally(() => {
        send.disabled = false;
        send.textContent = "Enviar";
      });
    }

    send.onclick = sendMessage;
    input.onkeydown = function(e){
      if (e.key === "Enter") sendMessage();
    };

    // Animaciones extra: focus en input, blur al enviar
    input.addEventListener('focus', () => {
      input.style.boxShadow = "0 0 0 2px #00c6fb";
    });
    input.addEventListener('blur', () => {
      input.style.boxShadow = "0 2px 8px 0 rgba(0, 54, 162, 0.12)";
    });

    // Animaci√≥n de apertura de chat y render temas/historial
    window.onload = () => {
      renderTemas();
      if (activeTemaId) loadAndRenderHistory();
    };

    // Para mejorar experiencia en m√≥viles: scroll al input al abrir teclado
    input.addEventListener("focus", () => {
      setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 350);
    });
  </script>
</body>
</html>
